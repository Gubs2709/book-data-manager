/**
 * @fileoverview Firestore Security Rules for Textbook and Notebook Management.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data. Each user can only access
 * their own data, which is organized under their unique user ID.  The rules are designed to
 * prevent unauthorized access and maintain data integrity.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information.
 * - /users/{userId}/uploads/{uploadId}: Stores metadata about uploads, including class, course, and default discounts/taxes.
 * - /users/{userId}/uploads/{uploadId}/textbooks/{textbookId}: Stores denormalized textbook data associated with an upload.
 * - /users/{userId}/uploads/{uploadId}/notebooks/{notebookId}: Stores denormalized notebook data associated with an upload.
 * - /users/{userId}/frequent_book_data/{frequentBookDataId}: Stores frequently used book data like discount and tax for easy reuse.
 *
 * Key Security Decisions:
 * - User listing is explicitly disallowed.
 * - Path-based ownership is enforced for most user-related data.
 * - For collectionGroup queries on 'textbooks' and 'notebooks', ownership is verified by checking a `userId` field on the document itself. This is critical for the Data Explorer.
 * - Data consistency between paths and document data is validated on create and update.
 *
 * Denormalization for Authorization:
 * - Each document under `/users/{userId}` inherently belongs to that user. The rules leverage this path structure for authorization, avoiding costly `get()` calls to verify ownership.
 * - Book documents in the `textbooks` and `notebooks` subcollections are denormalized with `userId`, `class`, etc., to allow for efficient and secure collectionGroup queries in the Data Explorer.
 *
 * This comment block explicitly defines the indexes required for the collectionGroup queries
 * in the Data Explorer. This ensures Firestore can efficiently and securely filter by `userId`.
 *
 * Index for 'textbooks' collection group:
 * - collectionGroup: textbooks
 * - queryScope: COLLECTION_GROUP
 * - fields:
 *   - fieldPath: userId
 *     order: ASCENDING
 *
 * Index for 'notebooks' collection group:
 * - collectionGroup: notebooks
 * - queryScope: COLLECTION_GROUP
 * - fields:
 *   - fieldPath: userId
 *     order: ASCENDING
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Defines a global function to check if a user is signed in.
     * @principle Requires authentication for all protected resources.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Defines a global function to check if the requesting user is the owner of the document via path.
     * @principle Enforces user-based ownership for data access based on URL path segments.
     */
    function isOwnerByPath(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * @description Defines a global function to check if the requesting user is the owner via a field on the resource.
     * @principle Enforces user-based ownership by checking a `userId` field on the document being read/written.
     */
    function isOwnerByField() {
        return isSignedIn() && request.auth.uid == request.resource.data.userId;
    }

    /**
     * @description Rule for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) User with ID 'user_abc' can create their own profile.
     * @deny (create) User with ID 'user_def' cannot create a profile for 'user_abc'.
     * @principle Allows users to create their own profile and enforces ownership.
     */
    match /users/{userId} {
      allow get: if false;
      allow list: if false;

      allow create: if isOwnerByPath(userId) && request.resource.data.id == userId;
      allow update: if isOwnerByPath(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isOwnerByPath(userId);
    }

    /**
     * @description Rule for the /users/{userId}/uploads/{uploadId} collection.
     * @path /users/{userId}/uploads/{uploadId}
     * @allow (create) User with ID 'user_abc' can create an upload under their profile.
     * @deny (create) User with ID 'user_def' cannot create an upload under 'user_abc's profile.
     * @principle Enforces user-based ownership for uploads.
     */
    match /users/{userId}/uploads/{uploadId} {
      allow get, list, delete: if isOwnerByPath(userId);
      allow create: if isOwnerByPath(userId) && request.resource.data.userId == userId;
      allow update: if isOwnerByPath(userId) && request.resource.data.userId == resource.data.userId;

      // Rules for the nested textbook and notebook collections
      match /textbooks/{textbookId} {
         allow get, delete: if isOwnerByPath(userId);
         allow create: if isOwnerByPath(userId) && isOwnerByField() && request.resource.data.uploadId == uploadId;
         allow update: if isOwnerByPath(userId) && isOwnerByField() && request.resource.data.uploadId == uploadId;
         // List is handled by the collectionGroup rule below.
         allow list: if false;
      }

      match /notebooks/{notebookId} {
         allow get, delete: if isOwnerByPath(userId);
         allow create: if isOwnerByPath(userId) && isOwnerByField() && request.resource.data.uploadId == uploadId;
         allow update: if isOwnerByPath(userId) && isOwnerByField() && request.resource.data.uploadId == uploadId;
         // List is handled by the collectionGroup rule below.
         allow list: if false;
      }
    }
    
    /**
     * @description Rule for the 'textbooks' collection group. This rule ensures that a user can only list their own textbooks.
     * The client query MUST use a `where("userId", "==", request.auth.uid)` clause.
     * @path /{path=**}/textbooks/{textbookId}
     * @principle Allows a user to list only their own textbooks across all uploads, secured by a 'userId' field check.
     */
    match /{path=**}/textbooks/{textbookId} {
       allow list: if resource.data.userId == request.auth.uid;
    }

    /**
     * @description Rule for the 'notebooks' collection group. This rule ensures that a user can only list their own notebooks.
     * The client query MUST use a `where("userId", "==", request.auth.uid)` clause.
     * @path /{path=**}/notebooks/{notebookId}
     * @principle Allows a user to list only their own notebooks across all uploads, secured by a 'userId' field check.
     */
     match /{path=**}/notebooks/{notebookId} {
       allow list: if resource.data.userId == request.auth.uid;
    }

    /**
     * @description Rule for the /users/{userId}/frequent_book_data/{frequentBookDataId} collection.
     * @path /users/{userId}/frequent_book_data/{frequentBookDataId}
     * @allow (create) User with ID 'user_abc' can create frequent book data under their profile.
     * @deny (create) User with ID 'user_def' cannot create frequent book data under 'user_abc's profile.
     * @principle Enforces user-based ownership for frequent book data.
     */
    match /users/{userId}/frequent_book_data/{frequentBookDataId} {
      allow read, write: if isOwnerByPath(userId);
    }
  }
}
